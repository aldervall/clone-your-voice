<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeuTTS-Air - Text to Speech</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>üéôÔ∏è NeuTTS-Air</h1>
            <p class="subtitle">Voice Cloning & Text-to-Speech</p>
        </header>

        <div class="card">
            <form id="ttsForm">
                <!-- Input Text -->
                <div class="form-group">
                    <label for="input_text">
                        <span class="label-icon">üìù</span>
                        Text to Synthesize *
                    </label>
                    <textarea
                        id="input_text"
                        name="input_text"
                        rows="4"
                        placeholder="Enter the text you want to convert to speech..."
                        required
                    ></textarea>
                </div>

                <!-- Reference Source Selection -->
                <div class="form-group">
                    <label>
                        <span class="label-icon">üéµ</span>
                        Reference Voice Source
                    </label>
                    <div class="radio-group">
                        <label class="radio-label">
                            <input type="radio" name="ref_source" value="sample" checked>
                            <span>Use Sample Voice</span>
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="ref_source" value="upload">
                            <span>Upload Custom Voice</span>
                        </label>
                    </div>
                </div>

                <!-- Sample Selection -->
                <div id="sampleSection" class="form-group">
                    <label for="sample_name">
                        <span class="label-icon">üë§</span>
                        Select Sample Voice
                    </label>
                    <select id="sample_name" name="sample_name">
                        {% for sample in samples %}
                        <option value="{{ sample.name }}">{{ sample.name|title }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Upload Section -->
                <div id="uploadSection" class="form-group" style="display: none;">
                    <label for="ref_audio">
                        <span class="label-icon">üé§</span>
                        Upload Reference Audio (WAV) *
                    </label>
                    <input
                        type="file"
                        id="ref_audio"
                        name="ref_audio"
                        accept=".wav,audio/wav"
                    >
                    <small class="help-text">
                        Upload a 3-15 second WAV file of the voice you want to clone
                    </small>
                </div>

                <!-- Reference Text -->
                <div class="form-group">
                    <label for="ref_text">
                        <span class="label-icon">üí¨</span>
                        Reference Text *
                    </label>
                    <textarea
                        id="ref_text"
                        name="ref_text"
                        rows="3"
                        placeholder="Enter the text that matches the reference audio..."
                        required
                    ></textarea>
                    <small class="help-text">
                        This should be the transcript of what's said in the reference audio
                    </small>
                </div>

                <!-- Model Selection -->
                <div class="form-group">
                    <label for="backbone">
                        <span class="label-icon">üß†</span>
                        Model
                    </label>
                    <select id="backbone" name="backbone">
                        <option value="neuphonic/neutts-air">Standard (neutts-air)</option>
                        <option value="neuphonic/neutts-air-q4-gguf">Q4 GGUF (faster, lower quality)</option>
                        <option value="neuphonic/neutts-air-q8-gguf">Q8 GGUF (balanced)</option>
                    </select>
                </div>

                <!-- Submit Button -->
                <button type="submit" class="btn btn-primary" id="submitBtn">
                    <span class="btn-text">Generate Speech</span>
                    <span class="loader" style="display: none;"></span>
                </button>
            </form>

            <!-- Progress Bar -->
            <div id="progressSection" class="progress-section" style="display: none;">
                <div class="progress-bar-container">
                    <div id="progressBar" class="progress-bar"></div>
                </div>
                <div id="progressMessage" class="progress-message">Initializing...</div>
            </div>

            <!-- Status Messages -->
            <div id="statusMessage" class="message" style="display: none;"></div>

            <!-- Audio Player -->
            <div id="audioPlayer" class="audio-section" style="display: none;">
                <h3>Generated Audio</h3>
                <audio id="audioElement" controls></audio>
                <div class="audio-actions">
                    <button id="downloadBtn" class="btn btn-secondary">
                        üì• Download WAV
                    </button>
                </div>
            </div>
        </div>

        <footer>
            <p>
                Powered by <a href="https://huggingface.co/neuphonic/neutts-air" target="_blank">NeuTTS-Air</a>
                | Created by <a href="https://neuphonic.com" target="_blank">Neuphonic</a>
            </p>
        </footer>
    </div>

    <script>
        // Handle reference source toggle
        const sampleRadio = document.querySelector('input[value="sample"]');
        const uploadRadio = document.querySelector('input[value="upload"]');
        const sampleSection = document.getElementById('sampleSection');
        const uploadSection = document.getElementById('uploadSection');
        const refAudioInput = document.getElementById('ref_audio');
        const refTextArea = document.getElementById('ref_text');
        const sampleSelect = document.getElementById('sample_name');

        sampleRadio.addEventListener('change', () => {
            sampleSection.style.display = 'block';
            uploadSection.style.display = 'none';
            refAudioInput.required = false;
            loadSampleText();
        });

        uploadRadio.addEventListener('change', () => {
            sampleSection.style.display = 'none';
            uploadSection.style.display = 'block';
            refAudioInput.required = true;
            refTextArea.value = '';
        });

        // Load sample text when sample is selected
        sampleSelect.addEventListener('change', loadSampleText);

        function loadSampleText() {
            const sampleName = sampleSelect.value;
            const samples = {{ samples|tojson }};
            const sample = samples.find(s => s.name === sampleName);

            if (sample && sample.txt) {
                refTextArea.value = sample.txt;
            } else {
                refTextArea.value = '';
            }
        }

        // Initialize with first sample's text
        loadSampleText();

        // Form submission
        const form = document.getElementById('ttsForm');
        const submitBtn = document.getElementById('submitBtn');
        const btnText = submitBtn.querySelector('.btn-text');
        const loader = submitBtn.querySelector('.loader');
        const statusMessage = document.getElementById('statusMessage');
        const progressSection = document.getElementById('progressSection');
        const progressBar = document.getElementById('progressBar');
        const progressMessage = document.getElementById('progressMessage');
        const audioPlayer = document.getElementById('audioPlayer');
        const audioElement = document.getElementById('audioElement');
        const downloadBtn = document.getElementById('downloadBtn');

        let eventSource = null;

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            // Prepare form data
            const formData = new FormData();
            formData.append('input_text', document.getElementById('input_text').value);
            formData.append('ref_text', refTextArea.value);
            formData.append('backbone', document.getElementById('backbone').value);

            if (sampleRadio.checked) {
                formData.append('use_sample', 'true');
                formData.append('sample_name', sampleSelect.value);
            } else {
                formData.append('use_sample', 'false');
                if (refAudioInput.files.length > 0) {
                    formData.append('ref_audio', refAudioInput.files[0]);
                }
            }

            // Show loading state
            submitBtn.disabled = true;
            btnText.style.display = 'none';
            loader.style.display = 'inline-block';
            statusMessage.style.display = 'none';
            audioPlayer.style.display = 'none';
            progressSection.style.display = 'block';
            progressBar.style.width = '0%';
            progressMessage.textContent = 'Starting...';

            try {
                // Start synthesis
                const response = await fetch('/api/synthesize', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok && result.session_id) {
                    // Connect to progress stream
                    connectToProgress(result.session_id);
                } else {
                    throw new Error(result.error || 'Unknown error');
                }
            } catch (error) {
                showMessage('‚ùå Error: ' + error.message, 'error');
                resetUI();
            }
        });

        function connectToProgress(sessionId) {
            // Close existing connection
            if (eventSource) {
                eventSource.close();
            }

            // Create new EventSource connection
            eventSource = new EventSource(`/api/progress/${sessionId}`);

            eventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);

                if (data.keepalive) {
                    // Ignore keepalive messages
                    return;
                }

                if (data.error) {
                    showMessage('‚ùå Error: ' + data.message, 'error');
                    resetUI();
                    eventSource.close();
                    return;
                }

                if (data.complete) {
                    // Synthesis complete
                    progressBar.style.width = '100%';
                    progressMessage.textContent = data.message;

                    // Show success message
                    setTimeout(() => {
                        showMessage('‚úÖ ' + data.message, 'success');
                        progressSection.style.display = 'none';

                        // Show audio player
                        audioElement.src = `/api/play/${data.output_file}`;
                        audioPlayer.style.display = 'block';

                        // Setup download button
                        downloadBtn.onclick = () => {
                            window.location.href = `/api/download/${data.output_file}`;
                        };

                        resetUI();
                    }, 500);

                    eventSource.close();
                    return;
                }

                // Update progress
                if (data.progress !== undefined) {
                    progressBar.style.width = data.progress + '%';
                    progressMessage.textContent = data.message;
                }
            };

            eventSource.onerror = function(error) {
                console.error('EventSource error:', error);
                showMessage('‚ùå Connection error. Please try again.', 'error');
                resetUI();
                eventSource.close();
            };
        }

        function resetUI() {
            submitBtn.disabled = false;
            btnText.style.display = 'inline';
            loader.style.display = 'none';
        }

        function showMessage(text, type) {
            statusMessage.textContent = text;
            statusMessage.className = 'message message-' + type;
            statusMessage.style.display = 'block';
        }
    </script>
</body>
</html>
